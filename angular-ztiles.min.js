/*! angular-ztiles (v0.2.0) - Copyright: 2014, Patrick Zimmermann (patrick@knowhere.guru) - MIT */
"use strict";angular.module("pz101.ztiles",[]).controller("zTilesController",function($scope){$scope.transcludeTemplate="",$scope.defaultOptions={padding:4,heightKey:"height",widthKey:"width",alignment:"lr",counts:[3]}}).factory("zTilesFactory",function(){return{rows:[],alignOffset:0,countsOffset:0}}).directive("zTiles",function($compile,$timeout,zTilesFactory){function link(scope,elem){function getTilesCount(){var i,num=0;for(i=0;i<zTilesFactory.rows.length;i++)num+=zTilesFactory.rows[i].na+zTilesFactory.rows[i].nb+1;return num}function ratio(tile){return tile[scope.defaultOptions.widthKey]/tile[scope.defaultOptions.heightKey]}function renderCSS(){var row,qa,qb,c,ra,rb,hc,hb,ha,wc,elems,n,$e,type,indexA,tileA,indexB,tileB,width=elem.innerWidth()-1,cssWidth=parseInt(elem.css("width"),10)-1,p=scope.defaultOptions.padding,r=0;for(width>cssWidth&&(width=cssWidth),elem.find(".z-tile").css("padding","0px").css("margin","0px"),r=0;r<zTilesFactory.rows.length;r++)if(0===zTilesFactory.rows[r].na&&0===zTilesFactory.rows[r].nb)for(elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)hc=(width+1)/zTilesFactory.rows[r].c,$e=angular.element(elems[n]),$e.css("height",hc+"px").css("width",width+1+"px").css("margin-bottom",p+"px");else if(1===zTilesFactory.rows[r].na&&0===zTilesFactory.rows[r].nb)for(hc=(width-scope.defaultOptions.padding)/(zTilesFactory.rows[r].c+zTilesFactory.rows[r].ra),wc=hc*zTilesFactory.rows[r].c,elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)$e=angular.element(elems[n]),type=$e.attr("tile-type"),"c"===type?$e.css("height",hc+"px").css("width",wc+"px").css("margin-bottom",p+"px"):"a"===type&&$e.css("height",hc+"px").css("width",zTilesFactory.rows[r].ra*hc+"px").css("margin-bottom",p+"px").css("margin-"+zTilesFactory.rows[r].float,p+"px");else for(row=zTilesFactory.rows[r],qa=(row.na-1)*p,qb=(row.nb-1)*p,c=row.c,ra=row.ra,rb=row.rb,hc=(qb-qa+ra*p+(rb+ra)*((p+qa-width)/ra-p))/(-rb-rb/ra*c-c),hb=(p+qa-width)/ra-p+(1+c/ra)*hc,ha=-p+hc-hb,wc=c*hc,elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)$e=angular.element(elems[n]),type=$e.attr("tile-type"),"c"===type?$e.css("height",hc+"px").css("width",wc+"px").css("margin-bottom",p+"px"):"a"===type?(indexA=row.offset+row.pa[$e.attr("tiles-col")],tileA=scope.tiles[indexA],$e.css("height",ha+"px").css("width",ratio(tileA)*ha+"px").css("margin-"+row.float,p+"px")):"b"===type&&(indexB=row.offset+row.pb[$e.attr("tiles-col")],tileB=scope.tiles[indexB],$e.css("width",ratio(tileB)*hb+"px").css("margin-top",p+"px").css("margin-bottom",p+"px").css("height",hb+"px").css("margin-"+row.float,p+"px"));scope.$evalAsync(function(){zTilesFactory.templateCache=elem.html(),scope.$broadcast("rerender")})}function createRow(tileSet,row,num,parent){var a,b;for(createDOM("c",num,0,tileSet[row.pc],parent),a=0;a<row.na;a++)createDOM("a",num,a,tileSet[parseInt(row.pa[a],10)],parent);for(b=0;b<row.nb;b++)createDOM("b",num,b,tileSet[parseInt(row.pb[b],10)],parent);parent.append('<div class="z-tiles-clear" style="clear:both" />')}function createDOM(type,row,col,tile,parent){var content,outterdiv='<div class="z-tile z-tiles-row-'+row+'" tiles-col="'+col+'" tile-type="'+type+'" style="float:'+zTilesFactory.rows[row].float+'">'+scope.transcludeTemplate+"</div>",isolatedScope=scope.$new(!0);isolatedScope.tile=tile,isolatedScope.mother=scope.$parent,content=$compile(outterdiv)(isolatedScope),parent.append(content)}function createGrid(parent,tileSet,offset,align){var n,c,pc,pa,pb,lastTime,i,ra,k,l,rb,row,lowestRatio=0;if(1===tileSet.length)c=ratio(tileSet[0]),pa=[],pb=[],ra=0,rb=0,row={c:c,ra:ra,rb:rb,na:pa.length,nb:pb.length,pa:pa,pb:pb,pc:0,offset:offset,"float":align},zTilesFactory.rows.push(row),createRow(tileSet,row,zTilesFactory.rows.length-1,parent);else if(2===tileSet.length)c=ratio(tileSet[0]),ra=ratio(tileSet[1]),row={c:c,ra:ra,rb:0,na:1,nb:0,pa:[1],pb:[],pc:0,offset:offset,"float":align},zTilesFactory.rows.push(row),createRow(tileSet,row,zTilesFactory.rows.length-1,parent);else if(tileSet.length>=3){for(n=0;n<tileSet.length;n++)ratio(tileSet[n])<ratio(tileSet[lowestRatio])&&(lowestRatio=n);for(c=ratio(tileSet[lowestRatio]),pc=lowestRatio,pa=[],pb=[],lastTime=null,i=0;i<tileSet.length;i++)i!==pc&&(null===lastTime&&(lastTime=!0),lastTime?pa.push(i):pb.push(i),lastTime=!lastTime);for(ra=0,k=0;k<pa.length;k++)ra+=ratio(tileSet[pa[k]]);for(rb=0,l=0;l<pb.length;l++)rb+=ratio(tileSet[pb[l]]);row={c:c,ra:ra,rb:rb,na:pa.length,nb:pb.length,pa:pa,pb:pb,pc:pc,offset:offset,"float":align},zTilesFactory.rows.push(row),createRow(tileSet,row,zTilesFactory.rows.length-1,parent)}}var $window;scope.$watch(function(){return elem.width()},function(){}),scope.options&&(scope.options.padding&&(scope.defaultOptions.padding=scope.options.padding),scope.options.widthKey&&(scope.defaultOptions.widthKey=scope.options.widthKey),scope.options.heightKey&&(scope.defaultOptions.heightKey=scope.options.heightKey),scope.options.alignment&&(scope.defaultOptions.alignment=scope.options.alignment),scope.options.counts&&angular.isArray(scope.options.counts)&&(scope.defaultOptions.counts=scope.options.counts)),elem.html()&&(scope.transcludeTemplate=elem.html(),elem.empty()),angular.isDefined(zTilesFactory.templateCache)&&elem.append(zTilesFactory.templateCache),$window=angular.element(window),$window.resize(function(){renderCSS()}),elem.resize(function(){renderCSS()}),scope.$watch("tiles",function(){var done,max,r,align,tilesCount,rowCount=0;if(scope.tiles&&getTilesCount()!==scope.tiles.length){for(done=getTilesCount(),tilesCount=scope.tiles.length;tilesCount>done;)max=tilesCount-done,zTilesFactory.countsOffset>=scope.defaultOptions.counts.length&&(zTilesFactory.countsOffset=0),r=Math.min(max,scope.defaultOptions.counts[zTilesFactory.countsOffset]),zTilesFactory.alignOffset>=scope.defaultOptions.alignment.length&&(zTilesFactory.alignOffset=0),align="l"===scope.defaultOptions.alignment[zTilesFactory.alignOffset]?"left":"r"===scope.defaultOptions.alignment[zTilesFactory.alignOffset]?"right":Math.random()>=.5?"right":"left",zTilesFactory.alignOffset++,zTilesFactory.countsOffset++,createGrid(elem,scope.tiles.slice(done,done+r),done,align),done+=r,rowCount++;scope.$evalAsync(function(){renderCSS()}),$timeout(function(){renderCSS()},100)}})}return{restrict:"A",scope:{tiles:"=",options:"=?"},controller:"zTilesController",link:link}});