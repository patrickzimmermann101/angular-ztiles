/*! angular-ztiles (v0.1.1) - Copyright: 2014, Patrick Zimmermann (patrick@knowhere.guru) - MIT */
"use strict";angular.module("pz101.ztiles",[]),angular.module("pz101.ztiles").directive("zTiles",function($compile){function link(scope,elem){function ratio(tile){return tile[widthKey]/tile[heightKey]}function renderCSS(){var width=elem.width()-1,p=padding;elem.find(".z-tile").css("padding","0px").css("margin","0px");for(var r=0;r<rows.length;r++)for(var row=rows[r],qa=(row.na-1)*p,qb=(row.nb-1)*p,c=row.c,ra=row.ra,rb=row.rb,hc=(qb-qa+ra*p+(rb+ra)*((p+qa-width)/ra-p))/(-rb-rb/ra*c-c),hb=(p+qa-width)/ra-p+(1+c/ra)*hc,ha=-p+hc-hb,wc=c*hc,elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++){var $e=angular.element(elems[n]),type=$e.attr("tile-type");if("c"===type)$e.css("height",hc+"px").css("width",wc+"px").css("margin-bottom",p+"px");else if("a"===type){var indexA=row.offset+row.pa[$e.attr("tiles-col")],tileA=scope.tiles[indexA];$e.css("height",ha+"px").css("width",ratio(tileA)*ha+"px").css("margin-"+row.float,p+"px")}else if("b"===type){var indexB=row.offset+row.pb[$e.attr("tiles-col")],tileB=scope.tiles[indexB];$e.css("width",ratio(tileB)*hb+"px").css("margin-top",p+"px").css("margin-bottom",p+"px").css("height",hb+"px").css("margin-"+row.float,p+"px")}}scope.$evalAsync(function(){templateCache=elem.html()})}function createRow(tileSet,row,num,parent){createDOM("c",num,0,tileSet[row.pc],parent);for(var a=0;a<row.na;a++)createDOM("a",num,a,tileSet[parseInt(row.pa[a],10)],parent);for(var b=0;b<row.nb;b++)createDOM("b",num,b,tileSet[parseInt(row.pb[b],10)],parent);parent.append('<div class="z-tiles-clear" style="clear:both" />')}function createDOM(type,row,col,tile,parent){var outterdiv='<div class="z-tile z-tiles-row-'+row+'" tiles-col="'+col+'" tile-type="'+type+'" style="float:'+rows[row].float+'">'+transcludeTemplate+"</div>",isolatedScope=scope.$new(!0);isolatedScope.tile=tile,isolatedScope.mother=scope.$parent;var content=$compile(outterdiv)(isolatedScope);parent.append(content)}function createGrid(parent,tileSet,offset){if(tileSet.length<3);else if(tileSet.length>=3){for(var lowestRatio=0,n=0;n<tileSet.length;n++)ratio(tileSet[n])<ratio(tileSet[lowestRatio])&&(lowestRatio=n);for(var c=ratio(tileSet[lowestRatio]),pc=lowestRatio,pa=[],pb=[],lastTime=null,i=0;i<tileSet.length;i++)i!==pc&&(null===lastTime&&(lastTime=!0),lastTime?pa.push(i):pb.push(i),lastTime=!lastTime);for(var ra=0,k=0;k<pa.length;k++)ra+=ratio(tileSet[pa[k]]);for(var rb=0,l=0;l<pb.length;l++)rb+=ratio(tileSet[pb[l]]);var row={c:c,ra:ra,rb:rb,na:pa.length,nb:pb.length,pa:pa,pb:pb,pc:pc,offset:offset,"float":"left"};rows.push(row),createRow(tileSet,row,rows.length-1,parent)}}scope.widthKey&&(widthKey=scope.widthKey),scope.heightKey&&(heightKey=scope.heightKey),scope.tilesPadding&&(padding=parseInt(scope.tilesPadding)),scope.maxTiles&&(maxTiles=parseInt(scope.maxTiles)),elem.html()&&(transcludeTemplate=elem.html(),elem.empty()),null!==templateCache&&elem.append(templateCache);var $window=angular.element(window);$window.resize(function(){renderCSS()}),elem.resize(function(){renderCSS()}),scope.tiles&&null!==templateCache&&(tilesCount=scope.tiles.length),scope.$watch("tiles",function(){if(scope.tiles&&tilesCount!==scope.tiles.length){var done=tilesCount;for(tilesCount=scope.tiles.length;tilesCount>done;){var max=Math.min(maxTiles+1,tilesCount-done),r=Math.min(max,3);max>3&&(r=Math.floor(Math.random()*(max-3)+3)),createGrid(elem,scope.tiles.slice(done,done+r),done),done+=r}renderCSS()}})}var tilesCount=0,rows=[],templateCache=null,padding=4,widthKey="width",heightKey="height",transcludeTemplate="",maxTiles=5;return{restrict:"A",scope:{tiles:"=tiles",widthKey:"@",heightKey:"@",tilesPadding:"@",maxTiles:"@"},link:link}});