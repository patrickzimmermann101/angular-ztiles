"use strict";angular.module("pz101.ztiles",[]),angular.module("pz101.ztiles").directive("zTiles",function($compile){function link(scope,elem){function tileCount(){var i,num=0;for(i=0;i<rows.length;i++)num+=rows[i].na+rows[i].nb+1;return num}function ratio(tile){return tile[options.widthKey]/tile[options.heightKey]}function renderCSS(){var row,qa,qb,c,ra,rb,hc,hb,ha,wc,elems,n,$e,type,indexA,tileA,indexB,tileB,width=elem.width()-1,p=options.padding,r=0;for(elem.find(".z-tile").css("padding","0px").css("margin","0px"),r=0;r<rows.length;r++)if(0===rows[r].na&&0===rows[r].nb)for(elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)hc=(width+1)/rows[r].c,$e=angular.element(elems[n]),$e.css("height",hc+"px").css("width",width+1+"px").css("margin-bottom",p+"px");else if(1===rows[r].na&&0===rows[r].nb)for(hc=(width-options.padding)/(rows[r].c+rows[r].ra),wc=hc*rows[r].c,elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)$e=angular.element(elems[n]),type=$e.attr("tile-type"),"c"===type?$e.css("height",hc+"px").css("width",wc+"px").css("margin-bottom",p+"px"):"a"===type&&$e.css("height",hc+"px").css("width",rows[r].ra*hc+"px").css("margin-bottom",p+"px").css("margin-"+rows[r].float,p+"px");else for(row=rows[r],qa=(row.na-1)*p,qb=(row.nb-1)*p,c=row.c,ra=row.ra,rb=row.rb,hc=(qb-qa+ra*p+(rb+ra)*((p+qa-width)/ra-p))/(-rb-rb/ra*c-c),hb=(p+qa-width)/ra-p+(1+c/ra)*hc,ha=-p+hc-hb,wc=c*hc,elems=elem.find(".z-tiles-row-"+r),n=0;n<elems.length;n++)$e=angular.element(elems[n]),type=$e.attr("tile-type"),"c"===type?$e.css("height",hc+"px").css("width",wc+"px").css("margin-bottom",p+"px"):"a"===type?(indexA=row.offset+row.pa[$e.attr("tiles-col")],tileA=scope.tiles[indexA],$e.css("height",ha+"px").css("width",ratio(tileA)*ha+"px").css("margin-"+row.float,p+"px")):"b"===type&&(indexB=row.offset+row.pb[$e.attr("tiles-col")],tileB=scope.tiles[indexB],$e.css("width",ratio(tileB)*hb+"px").css("margin-top",p+"px").css("margin-bottom",p+"px").css("height",hb+"px").css("margin-"+row.float,p+"px"));scope.$evalAsync(function(){templateCache=elem.html()})}function createRow(tileSet,row,num,parent){var a,b;for(createDOM("c",num,0,tileSet[row.pc],parent),a=0;a<row.na;a++)createDOM("a",num,a,tileSet[parseInt(row.pa[a],10)],parent);for(b=0;b<row.nb;b++)createDOM("b",num,b,tileSet[parseInt(row.pb[b],10)],parent);parent.append('<div class="z-tiles-clear" style="clear:both" />')}function createDOM(type,row,col,tile,parent){var content,outterdiv='<div class="z-tile z-tiles-row-'+row+'" tiles-col="'+col+'" tile-type="'+type+'" style="float:'+rows[row].float+'">'+transcludeTemplate+"</div>",isolatedScope=scope.$new(!0);isolatedScope.tile=tile,isolatedScope.mother=scope.$parent,content=$compile(outterdiv)(isolatedScope),parent.append(content)}function createGrid(parent,tileSet,offset,align){var n,c,pc,pa,pb,lastTime,i,ra,k,l,rb,row,lowestRatio=0;if(1===tileSet.length)c=ratio(tileSet[0]),pa=[],pb=[],ra=0,rb=0,row={c:c,ra:ra,rb:rb,na:pa.length,nb:pb.length,pa:pa,pb:pb,pc:0,offset:offset,"float":align},rows.push(row),createRow(tileSet,row,rows.length-1,parent);else if(2===tileSet.length)c=ratio(tileSet[0]),ra=ratio(tileSet[1]),row={c:c,ra:ra,rb:0,na:1,nb:0,pa:[1],pb:[],pc:0,offset:offset,"float":align},rows.push(row),createRow(tileSet,row,rows.length-1,parent);else if(tileSet.length>=3){for(n=0;n<tileSet.length;n++)ratio(tileSet[n])<ratio(tileSet[lowestRatio])&&(lowestRatio=n);for(c=ratio(tileSet[lowestRatio]),pc=lowestRatio,pa=[],pb=[],lastTime=null,i=0;i<tileSet.length;i++)i!==pc&&(null===lastTime&&(lastTime=!0),lastTime?pa.push(i):pb.push(i),lastTime=!lastTime);for(ra=0,k=0;k<pa.length;k++)ra+=ratio(tileSet[pa[k]]);for(rb=0,l=0;l<pb.length;l++)rb+=ratio(tileSet[pb[l]]);row={c:c,ra:ra,rb:rb,na:pa.length,nb:pb.length,pa:pa,pb:pb,pc:pc,offset:offset,"float":align},rows.push(row),createRow(tileSet,row,rows.length-1,parent)}}var $window;scope.options&&(scope.options.padding&&(options.padding=scope.options.padding),scope.options.widthKey&&(options.widthKey=scope.options.widthKey),scope.options.heightKey&&(options.heightKey=scope.options.heightKey),scope.options.alignment&&(options.alignment=scope.options.alignment),scope.options.counts&&angular.isArray(scope.options.counts)&&(options.counts=scope.options.counts)),scope.maxTiles&&(maxTiles=parseInt(scope.maxTiles)),elem.html()&&(transcludeTemplate=elem.html(),elem.empty()),null!==templateCache&&elem.append(templateCache),$window=angular.element(window),$window.resize(function(){renderCSS()}),elem.resize(function(){renderCSS()}),scope.tiles&&null!==templateCache&&(tilesCount=scope.tiles.length),scope.$watch("tiles",function(){var done,max,r,align,rowCount=0;if(scope.tiles&&tileCount()!==scope.tiles.length){for(done=tileCount(),tilesCount=scope.tiles.length;tilesCount>done;)max=Math.min(maxTiles,tilesCount-done),countsOffset>=options.counts.length&&(countsOffset=0),r=Math.min(max,options.counts[countsOffset]),alignOffset>=options.alignment.length&&(alignOffset=0),align="l"===options.alignment[alignOffset]?"left":"r"===options.alignment[alignOffset]?"right":Math.random()>=.5?"right":"left",alignOffset++,countsOffset++,createGrid(elem,scope.tiles.slice(done,done+r),done,align),done+=r,rowCount++;renderCSS()}})}var tilesCount=0,rows=[],templateCache=null,transcludeTemplate="",maxTiles=5,alignOffset=0,countsOffset=0,options={padding:4,heightKey:"height",widthKey:"width",alignment:"lr",counts:[3]};return{restrict:"A",scope:{tiles:"=",maxTiles:"@",options:"=?"},link:link}});